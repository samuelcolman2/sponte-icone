<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ícone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="https://storage.googleapis.com/ecdt-logo-saida/1ebe52af502e25d3521cb9dad62bb72f6bc1c347353cdda5fa381ef8627a9eb8/COLEGIO-E-CURSO-ICONE.webp" type="image/x-icon">

  <!-- Tailwind para estilizar a NAVBAR -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  :root{
    --bg:#ffffff;
    --card:#ffffff;
    --muted:#6b7280;
    --brand:#FD7F08;
    --panel-h:560px;
    --alunos-max-h:520px;
    --text:#111827;
    --border:#a5acb9;
    --danger:#dc2626;
    --danger-hover:#b91c1c;
  }

  *{ box-sizing:border-box; color:var(--text); }
  body{
    margin:0;
    font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
  }

  header{ padding:24px; text-align:center }
  h1{ margin:0 0 6px }

  .container{ max-width:1200px; margin:0 auto; padding:0 16px 48px }
  .cols{ display:grid; grid-template-columns:1fr; gap:18px }

  .card{
    background:var(--card);
    border-radius:16px;
    box-shadow:0 4px 10px rgba(0,0,0,.06);
    border:1px solid var(--border);
    padding:20px;
    display:grid;
    grid-template-rows:auto 1fr;
    height:var(--panel-h);
    overflow:hidden;
  }

  .card-compact{ height:auto; grid-template-rows:auto auto; padding:16px; }
  .muted{ color:var(--muted) }

  table{ width:100%; border-collapse:collapse; background:#ffffff }
  th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:16px; vertical-align:top; }
  tbody tr:hover td{ color:var(--brand); background:#ffffff }

  a{ color:inherit; text-decoration:none }
  a:hover{ color:var(--brand) }

  button{ padding:10px 12px; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer; font-weight:600; border:1px solid var(--brand); transition:all .2s ease; min-height:44px; }
  button:hover{ transform:scale(1.05); background:var(--brand); color:#fff; border-color:var(--brand); }

  button.ver-alunos{ padding:5px 5px; font-size:15px; background-color:var(--brand); color:#fff; border:1px solid var(--brand); border-radius:10px; cursor:pointer; font-weight:600; transition:all .2s ease; }
  button.ver-alunos:hover{ background-color:var(--brand); color:#fff; border-color:var(--brand); transform:scale(1.05); }

  .select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    display:inline-block; background:var(--brand); color:#fff;
    border-radius:15px; padding:8px 14px; border:1px solid var(--brand);
    font-weight:600; cursor:pointer; transition:all .2s ease;
  }
  .select:hover,.select:focus{ transform:scale(1.05); background:var(--brand); color:#fff; border-color:var(--brand); outline:none; }
  .select option{ color:var(--text); background:#ffffff; }
  .arrow-down{ position:absolute; right:10px; top:50%; transform:translateY(-50%); width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid white; pointer-events:none; }

  .tag{
    font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    color:var(--brand);
    border:1px solid var(--brand);
    border-radius:6px;
    padding:2px 8px;
    margin-left:10px;
  }

  .scroll,.alunos-scroll{ margin-top:12px; overflow:auto; min-height:0 }

  .control-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  label{ font-weight:700 }

  .kpi-grid{ display:flex; gap:24px; flex-wrap:wrap; margin-top:8px }
  .kpi-box{ display:flex; align-items:baseline; gap:10px; }
  .kpi-number{ font-size:36px; font-weight:900; color:var(--brand); line-height:1; }
  .kpi-label{ font-size:14px; color:var(--muted); }
  .kpi-sub{ display:flex; align-items:baseline; gap:10px; margin-top:12px }
  .hidden{ display:none !important; }

  .aluno-cell{ display:flex; align-items:center; gap:10px; }
  .aluno-foto{ width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#f2f2f2; }

  /* ===== MODAL ===== */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; background:rgba(17,24,39,.5); z-index:9999; }
  .modal.is-open{ display:flex; }
  .modal-dialog{ width:min(1000px,96vw); max-height:85vh; background:var(--card); border-radius:16px; border:1px solid var(--border); box-shadow:0 20px 60px rgba(0,0,0,.2); display:grid; grid-template-rows:auto 1fr; overflow:hidden; animation:pop .14s ease-out; }
  @keyframes pop{ from{ transform:scale(.96); opacity:.6 } to{ transform:scale(1); opacity:1 } }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 16px; border-bottom:1px solid var(--border); }
  .modal-body{ padding:8px 16px 16px; overflow:auto }
  .btn-icon{ background:transparent; color:var(--text); border:1px solid var(--border); }
  .btn-icon:hover{ background:#fff; }
  .no-scroll{ overflow:hidden; }

  /* ===== PERFIL BOX (ficha do aluno) ===== */
  #modalFicha .modal-body{
    overflow: hidden;
    display: grid;
    grid-template-rows: 1fr;
  }
  .perfil-card{
    width:min(560px, 92vw);
    margin:0 auto;
    background:#fff;
    border-radius:16px;
    border:1px solid var(--border);
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    display:grid;
    grid-template-rows:auto 1fr;
    height: 100%;
    max-height: none;
    overflow:hidden;
  }
  .perfil-top{ padding:24px 24px 12px; text-align:center; position:relative; }
  .perfil-avatar{ width:96px; height:96px; border-radius:50%; display:inline-grid; place-items:center; background:#e5e7eb; color:#374151; font-weight:800; border:4px solid #fff; box-shadow:0 4px 12px rgba(0,0,0,.08); object-fit:cover; }
  .perfil-nome{ margin:10px 0 4px; font-size:24px; font-weight:900; }
  .perfil-sub{ color:var(--muted); font-size:14px; }
  .perfil-scroll{ padding:16px 20px 24px; overflow:auto; min-height: 0; }
  .campo{ margin:12px 0 0 }
  .campo label{ display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
  .valor{ font-weight:700; }
  .responsavel{ padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; margin-top:8px; }

  /*Deixar a cor do nome do aluno laranja também*/
  #modalAlunos #tblAlunos tbody tr:hover td{ color: var(--brand); background: #ffffff; }
  #modalAlunos .aluno-cell span{ transition: color .15s ease; cursor: pointer; }
  #modalAlunos .aluno-cell span:hover{ color: var(--brand); }
  #modalAlunos .aluno-cell:hover .aluno-foto{ border-color: var(--brand); }

  /*Botão de fechar*/
  button.btn-icon{ background: var(--danger) !important; color: #fff !important; border: 1px solid var(--danger) !important; font-weight: 900; line-height: 1; padding: 8px 12px; border-radius: 10px; }
  button.btn-icon:hover, button.btn-icon:focus{ background: var(--danger-hover) !important; border-color: var(--danger-hover) !important; color:#fff !important; transform: scale(1.05); outline: none; }
  button[aria-label="Fechar"], button[aria-label="fechar"], button[title~="Fechar"], button[title~="fechar"]{ background: var(--danger) !important; color:#fff !important; border:1px solid var(--danger) !important; }
  button[aria-label="Fechar"]:hover, button[aria-label="fechar"]:hover, button[title~="Fechar"]:hover, button[title~="fechar"]:hover{ background: var(--danger-hover) !important; border-color: var(--danger-hover) !important; color:#fff !important; }
  .btn-icon > *, button[aria-label="Fechar"] > *, button[title~="Fechar"] > *{ color:#fff !important; fill:#fff !important; stroke:#fff !important; }

  /* ========================= */
  /*        MOBILE FIXES       */
  /* ========================= */
  @media (max-width: 1024px){
    :root{ --panel-h:auto; }
    .card{ height:auto; padding:16px; }
  }

  /* Mobile: até tablets pequenos */
  @media (max-width: 768px){
    header{ padding:12px; }
    .container{ padding:0 12px 28px; }
    .control-row{ gap:10px; }

    /* NAV altura mais compacta sem alterar Tailwind no HTML */
    nav .max-w-7xl > .flex{ height:4.5rem; }

    .kpi-grid{ gap:12px; }
    .kpi-number{ font-size:28px; }
    .kpi-label{ font-size:13px; }

    th,td{ padding:8px; font-size:14px; }
    .aluno-foto{ width:32px; height:32px; }

    /* Cards e áreas de rolagem mais curtas para caber no viewport */
    .scroll, .alunos-scroll{ max-height:60dvh; }

    /* Modal vira "fullscreen" amigável no mobile */
    .modal{ padding:0; }
    .modal-dialog{ width:100vw; height:100dvh; max-height:100dvh; border-radius:0; }
    .modal-header{ position:sticky; top:0; background:var(--card); z-index:2; }
    #modalAlunos .modal-body, #modalFicha .modal-body{ padding:0 0 8px; }
    .alunos-scroll{ height:calc(100dvh - 64px); }

    /* Perfil box ocupa toda a tela no mobile */
    .perfil-card{ width:100%; height:100%; max-height:100%; border-radius:0; }
    .perfil-top{ padding:16px 16px 8px; }
    .perfil-avatar{ width:80px; height:80px; }
    .perfil-nome{ font-size:20px; }
    .perfil-sub{ font-size:13px; }

    /* Botão "ver alunos" ocupa a largura para facilitar o toque */
    button.ver-alunos{ width:100%; padding:10px 12px; font-size:16px; }

    /* Seletores mais "touch-friendly" */
    .select{ padding:10px 16px; border-radius:12px; }
    .arrow-down{ right:12px; }

    /* Evita quebra feia de KPI subtitle */
    #kpiLabelTurma{ max-width:70vw; }
  }

  /* Mobile pequeno: esconde colunas menos críticas e ajusta tipografia */
  @media (max-width: 480px){
    h3{ font-size:18px; }
    .tag{ font-size:11px; padding:1px 6px; }

    /* TURMAS: esconder Turno e AnoLetivo */
    #tblTurmas th:nth-child(2),
    #tblTurmas td:nth-child(2),
    #tblTurmas th:nth-child(3),
    #tblTurmas td:nth-child(3){ display:none; }

    /* ALUNOS: esconder RA e Situação */
    #tblAlunos th:nth-child(2),
    #tblAlunos td:nth-child(2),
    #tblAlunos th:nth-child(3),
    #tblAlunos td:nth-child(3){ display:none; }

    /* reduz ainda mais paddings */
    th,td{ padding:8px 6px; font-size:13px; }
  }

  /* iOS Safari barra dinâmica */
  @supports (height: 100svh){
    @media (max-width: 768px){
      .modal-dialog{ height:100svh; max-height:100svh; }
      .alunos-scroll{ height:calc(100svh - 64px); }
    }
  }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="sticky top-0 z-50 bg-white border-b-[3px] border-[#FD7F08]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-24">
        <div class="flex-shrink-0">
          <a href="#" class="flex items-center">
            <img class="h-16 w-auto" src="/images/logo-svg.png" alt="Logo Ícone Colégio e Curso"
                 onerror="this.onerror=null;this.src='https://placehold.co/150x50/eeeeee/333333?text=Logo';">
          </a>
        </div>
        <!-- Seletor de unidade -->
        <div class="control-row">
          <label for="selUnidade">Unidade:</label>
          <div class="relative inline-block">
            <select id="selUnidade" class="select pr-8">
              <option value="1">Unidade 1</option>
              <option value="2" selected>Unidade 2</option>
              <option value="5">Unidade 5</option>
            </select>
            <span class="arrow-down"></span>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <header></header>

  <div class="container cols">
    <!-- TURMAS -->
    <div class="card">
      <div class="control-row" style="justify-content:space-between">
        <h3 style="margin:0">Turmas</h3>
        <!-- removido statusTurmas -->
      </div>
      <div class="scroll">
        <table id="tblTurmas" style="display:none">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Turno</th>
              <th>AnoLetivo</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody id="tbodyTurmas"></tbody>
        </table>
      </div>
    </div>

    <!-- RESUMOS -->
    <div id="cardResumoTurmas" class="card card-compact" style="display:none">
      <div class="control-row" style="justify-content:space-between">
        <h3 style="margin:0">Turmas</h3>
        <div id="statusResumoTurmas" class="muted">—</div>
      </div>
      <div class="kpi-grid">
        <div class="kpi-box"><div id="kpiTotalTurmas" class="kpi-number">—</div><div class="kpi-label">turma(s) abertas</div></div>
      </div>
    </div>

    <div id="cardResumoAlunos" class="card card-compact" style="display:none">
      <div class="control-row" style="justify-content:space-between">
        <h3 style="margin:0">Alunos</h3>
        <div id="statusResumoAlunos" class="muted">—</div>
      </div>
      <div class="kpi-grid">
        <div class="kpi-box"><div id="kpiTotalAlunosUnidade" class="kpi-number">—</div><div class="kpi-label">alunos na unidade</div></div>
      </div>
      <div id="kpiTurmaSelecionada" class="kpi-sub hidden">
        <div id="kpiQtdAlunosTurma" class="kpi-number">0</div>
        <div id="kpiLabelTurma" class="kpi-label">alunos na turma selecionada</div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL: ALUNOS DA TURMA ===== -->
  <div id="modalAlunos" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalAlunosTitulo">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 id="modalAlunosTitulo" style="margin:0">Alunos da Turma</h3>
        <div class="control-row">
          <!-- removido statusAlunos -->
          <button id="btnFecharModal" class="btn-icon" aria-label="Fechar">✕</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="alunos-scroll">
          <table id="tblAlunos" style="display:none">
            <thead><tr><th>Nome</th><th>RA</th><th>Situação</th></tr></thead>
            <tbody id="tbodyAlunos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL: FICHA DO ALUNO (BOX) ===== -->
  <div id="modalFicha" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalFichaTitulo">
    <div class="modal-dialog" style="max-width:820px">
      <div class="modal-header">
        <h3 id="modalFichaTitulo" style="margin:0">Ficha do Aluno</h3>
        <div class="control-row">
          <!-- removido statusFicha -->
          <button id="btnFecharFicha" class="btn-icon" aria-label="Fechar">✕</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="perfil-card">
          <div class="perfil-top">
            <img id="fx_avatar" class="perfil-avatar" src="https://placehold.co/96x96/eeeeee/444?text=%F0%9F%91%A3" alt="Foto do aluno">
            <div id="fx_nome" class="perfil-nome">—</div>
            <div id="fx_sub" class="perfil-sub">—</div>
          </div>
          <div class="perfil-scroll">
            <div class="campo">
              <label>Gênero</label>
              <div id="fx_sexo" class="valor">—</div>
            </div>
            <div class="campo">
              <label>CPF</label>
              <div id="fx_cpf" class="valor">—</div>
            </div>
            <div class="campo">
              <label>Login do Portal</label>
              <div id="fx_login" class="valor">—</div>
            </div>
            <div class="campo">
              <label>Senha do Portal</label>
              <div id="fx_senha" class="valor">—</div>
            </div>
            <div class="campo">
              <label>Endereço</label>
              <div id="fx_endereco" class="valor">—</div>
            </div>
            <div class="campo">
              <label>Responsáveis</label>
              <div id="fx_responsaveis">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIGURAÇÃO DAS UNIDADES ====
    const UNIDADES = {
      "1": { nome: "Unidade 1", CODIGO_CLIENTE: 18935, TOKEN_API: "YF0ipnJjeIxd" },
      "2": { nome: "Unidade 2", CODIGO_CLIENTE: 70293, TOKEN_API: "YF0ipnJjeIxd" },
      "5": { nome: "Unidade 5", CODIGO_CLIENTE: 488368, TOKEN_API: "YF0ipnJjeIxd" }
    };

    const DEFAULT_MODULO = 1;
    const OPTIONAL_ANO_LETIVO = "2025";
    const ns = "http://api.sponteeducacional.net.br/";

    const q = (el, tag) => el.getElementsByTagName(tag)[0] || el.getElementsByTagNameNS(ns, tag)[0];
    const qt = (el, tag) => { const n = q(el, tag); return n ? (n.textContent || "").trim() : ""; };
    const qAll = (el, tag) => {
      const a = Array.from(el.getElementsByTagName(tag));
      return a.length ? a : Array.from(el.getElementsByTagNameNS(ns, tag));
    };
    const mapTurno = (v) => ({ "-1":"MANHÃ","-2":"TARDE","-3":"NOITE","-4":"INTEGRAL" }[v] || v || "");

    function calcularIdade(dnStr){
      if(!dnStr) return "";
      let d=null;
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(dnStr)){
        const [dd,mm,aa]=dnStr.split("/");
        d=new Date(+aa, +mm-1, +dd);
      }else{
        const t = Date.parse(dnStr);
        if(!isNaN(t)) d=new Date(t);
      }
      if(!d) return "";
      const hoje=new Date();
      let idade=hoje.getFullYear()-d.getFullYear();
      const m=hoje.getMonth()-d.getMonth();
      if(m<0 || (m===0 && hoje.getDate()<d.getDate())) idade--;
      return `${idade} ano${idade===1?"":"s"}`;
    }

    function fetchXML(url){
      return new Promise((resolve,reject)=>{
        const xhr=new XMLHttpRequest();
        xhr.open("GET",url,true);
        xhr.responseType="document";
        xhr.onreadystatechange=()=>{if(xhr.readyState===4){
          if(xhr.status===200&&xhr.responseXML)resolve(xhr.responseXML);
          else reject(new Error(`Erro ${xhr.status}`));
        }};
        xhr.onerror=()=>reject(new Error("Erro de rede"));
        xhr.send();
      });
    }

    // ---- API wrappers ----
    async function getTurmasAbertas(codigoCliente, token){
      const base="https://api.sponteeducacional.net.br/WSAPIEdu.asmx/GetTurmas";
      const sParametrosBusca="Situacao=-1";
      const url=base+`?nCodigoCliente=${codigoCliente}&sToken=${token}&sParametrosBusca=${encodeURIComponent(sParametrosBusca)}`;
      const xml=await fetchXML(url);
      const nodes=qAll(xml,"wsTurma");
      return nodes.map(t=>({
        TurmaID:qt(t,"TurmaID"), Nome:qt(t,"Nome"), Turno:qt(t,"Turno"), AnoLetivo:qt(t,"AnoLetivo"),
      }));
    }

    function parseIntegrantesTurma(wrapper){
      const nomeTurma = qt(wrapper,"Nome");
      const integrantesRoot = q(wrapper,"Integrantes") || wrapper;
      let nodes = qAll(integrantesRoot,"wsIntegrante");
      if(!nodes.length){ nodes = Array.from(integrantesRoot.children).filter(el=>q(el,"Nome")); }
      const integrantes = nodes.map(n=>({
        AlunoID: qt(n,"AlunoID") || qt(n,"PessoaID") || "",
        Nome: qt(n,"Nome"),
        RA: qt(n,"RA"),
        Situacao: qt(n,"Situacao")
      })).filter(a=>a.Nome||a.RA||a.Situacao||a.AlunoID);
      return {nomeTurma,integrantes};
    }

    async function getIntegrantesTurma(codigoCliente, token, turmaId, modulo=DEFAULT_MODULO){
      const base="https://api.sponteeducacional.net.br/WSAPIEdu.asmx/GetIntegrantesTurmas";
      let sParametrosBusca=`TurmaID=${turmaId};Modulo=${modulo}`;
      if(OPTIONAL_ANO_LETIVO) sParametrosBusca+=`;AnoLetivo=${OPTIONAL_ANO_LETIVO}`;
      const url=base+`?nCodigoCliente=${codigoCliente}&sToken=${token}&sParametrosBusca=${encodeURIComponent(sParametrosBusca)}`;
      const xml=await fetchXML(url);
      const wrapper=q(xml,"wsIntegrantesTurma")||xml;
      return parseIntegrantesTurma(wrapper);
    }

    function parseAluno(node){
      const respWrapper = q(node,"Responsaveis");
      const respList = respWrapper ? qAll(respWrapper, "wsResponsaveis").map(r=>({
        ResponsavelID: qt(r,"ResponsavelID"),
        Nome: qt(r,"Nome"),
        Parentesco: qt(r,"Parentesco"),
      })) : [];
      return {
        AlunoID: qt(node,"AlunoID"),
        Nome: qt(node,"Nome"),
        CPF: qt(node,"CPF"),
        Sexo: qt(node,"Sexo"),
        DataNascimento: qt(node,"DataNascimento"),
        LoginPortal: qt(node,"LoginPortal"),
        SenhaPortal: qt(node,"SenhaPortal"),
        Endereco: qt(node,"Endereco"),
        NumeroEndereco: qt(node,"NumeroEndereco"),
        Bairro: qt(node,"Bairro"),
        Cidade: qt(node,"Cidade"),
        CEP: qt(node,"CEP"),
        Responsaveis: respList,
      };
    }

    async function getFotoAluno(codigoCliente, token, alunoId){
      if(!alunoId) return null;
      const base="https://api.sponteeducacional.net.br/WSAPIEdu.asmx/GetImageApp";
      const url = `${base}?nCodigoCliente=${codigoCliente}&nAlunoID=${alunoId}&nResponsavelID=0&sToken=${token}`;
      try{
        const xml = await fetchXML(url);
        const fotoTag = xml.getElementsByTagName("wsFotoApp")[0];
        const node = fotoTag && fotoTag.childNodes && fotoTag.childNodes[7];
        const b64 = node && (node.textContent || node.innerHTML || "").trim();
        return b64 ? `data:image/jpeg;base64,${b64}` : null;
      }catch(e){ return null; }
    }

    async function getAlunoDetalhes(codigoCliente, token, alunoId, nomeAluno){
      const base = "https://api.sponteeducacional.net.br/WSAPIEdu.asmx/GetAlunos";
      async function chamar(sParametrosBusca){
        const url = `${base}?nCodigoCliente=${encodeURIComponent(codigoCliente)}&sToken=${encodeURIComponent(token)}&sParametrosBusca=${encodeURIComponent(sParametrosBusca)}`;
        const xml = await fetchXML(url);
        const nodes = qAll(xml, "wsAluno");
        return nodes.map(parseAluno);
      }
      try{
        const porId = await chamar(`AlunoID=${alunoId}`);
        if(porId && porId.length) return porId[0];
      }catch(e){}
      try{
        const porNome = await chamar(`Nome=${nomeAluno||""}`);
        const exata = porNome.find(a=>a.AlunoID===String(alunoId));
        return exata || porNome[0] || null;
      }catch(e){ console.error(e); return null; }
    }

    // ---- Estado/UI ----
    const selUnidade=document.getElementById("selUnidade");
    const tblTurmas=document.getElementById("tblTurmas");
    const tbodyTurmas=document.getElementById("tbodyTurmas");

    const modalAlunos = document.getElementById('modalAlunos');
    const btnFecharModal = document.getElementById('btnFecharModal');
    const tblAlunos=document.getElementById("tblAlunos");
    const tbodyAlunos=document.getElementById("tbodyAlunos");

    const cardResumoTurmas = document.getElementById("cardResumoTurmas");
    const statusResumoTurmas = document.getElementById("statusResumoTurmas");
    const kpiTotalTurmas = document.getElementById("kpiTotalTurmas");

    const cardResumoAlunos = document.getElementById("cardResumoAlunos");
    const statusResumoAlunos = document.getElementById("statusResumoAlunos");
    const kpiTotalAlunosUnidade = document.getElementById("kpiTotalAlunosUnidade");
    const kpiTurmaSelecionada = document.getElementById("kpiTurmaSelecionada");
    const kpiQtdAlunosTurma = document.getElementById("kpiQtdAlunosTurma");
    const kpiLabelTurma = document.getElementById("kpiLabelTurma");

    // Títulos que passam a exibir o "status" contextual
    const modalAlunosTitulo = document.getElementById('modalAlunosTitulo');
    const modalFichaTitulo  = document.getElementById('modalFichaTitulo');

    // Ficha (box)
    const modalFicha = document.getElementById('modalFicha');
    const btnFecharFicha = document.getElementById('btnFecharFicha');

    const FX = {
      avatar: document.getElementById('fx_avatar'),
      nome: document.getElementById('fx_nome'),
      sub: document.getElementById('fx_sub'),
      sexo: document.getElementById('fx_sexo'),
      cpf: document.getElementById('fx_cpf'),
      login: document.getElementById('fx_login'),
      senha: document.getElementById('fx_senha'),
      end: document.getElementById('fx_endereco'),
      resps: document.getElementById('fx_responsaveis'),
    };

    function getUnidadeAtual(){ const key = selUnidade.value || "2"; return UNIDADES[key]; }

    function limparAlunos(){
      tblAlunos.style.display="none";
      tbodyAlunos.innerHTML="";
      kpiTurmaSelecionada.classList.add("hidden");
    }

    function abrirModal(){ modalAlunos.classList.add('is-open'); modalAlunos.setAttribute('aria-hidden','false'); document.body.classList.add('no-scroll'); }
    function fecharModal(){ modalAlunos.classList.remove('is-open'); modalAlunos.setAttribute('aria-hidden','true'); document.body.classList.remove('no-scroll'); }

    function abrirModalFicha(){ modalFicha.classList.add('is-open'); modalFicha.setAttribute('aria-hidden','false'); document.body.classList.add('no-scroll'); }
    function fecharModalFicha(){ modalFicha.classList.remove('is-open'); modalFicha.setAttribute('aria-hidden','true'); document.body.classList.remove('no-scroll'); }

    btnFecharFicha.addEventListener('click', fecharModalFicha);
    modalFicha.addEventListener('click', (e)=>{ if(e.target===modalFicha) fecharModalFicha(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalFicha.classList.contains('is-open')) fecharModalFicha(); });

    // KPIs gerais
    async function contarAlunosUnidade(codigoCliente, token, turmas){
      let total = 0;
      for(const t of turmas){
        try{
          const { integrantes } = await getIntegrantesTurma(codigoCliente, token, t.TurmaID);
          total += integrantes.length;
        }catch(e){ console.warn("Falhou turma", t.TurmaID, e); }
      }
      return total;
    }

    async function preencherQtdAlunosPorTurma(codigoCliente, token, turmas){
      for(const t of turmas){
        const safeId = String(t.TurmaID || "").replace(/[^a-zA-Z0-9_-]/g, "");
        const alvo = document.getElementById(`qtd-${safeId}`);
        if(!alvo) continue;
        await new Promise(r=>setTimeout(r,120));
        try{
          const { integrantes } = await getIntegrantesTurma(codigoCliente, token, t.TurmaID);
          alvo.textContent = integrantes.length;
          alvo.setAttribute("title", `${integrantes.length} aluno(s)`);
        }catch(e){
          console.warn("Falha ao contar alunos da turma", t.TurmaID, e);
          alvo.textContent = "—";
          alvo.setAttribute("title", "Não foi possível obter a quantidade");
        }
      }
    }

    async function carregarTurmas(){
      limparAlunos();
      const { CODIGO_CLIENTE, TOKEN_API, nome } = getUnidadeAtual();
      try{
        cardResumoTurmas.style.display="none";
        cardResumoAlunos.style.display="none";
        kpiTotalTurmas.textContent="—";
        kpiTotalAlunosUnidade.textContent="—";
        statusResumoTurmas.textContent="—";
        statusResumoAlunos.textContent="—";

        const turmas=await getTurmasAbertas(CODIGO_CLIENTE, TOKEN_API);

        tblTurmas.style.display="";
        tbodyTurmas.innerHTML=turmas.map(t=>{
          const safeId = String(t.TurmaID || "").replace(/[^a-zA-Z0-9_-]/g, "");
          return `
          <tr>
            <td>${t.Nome||""} <span class="tag" id="qtd-${safeId}" title="Quantidade de alunos">…</span></td>
            <td>${mapTurno(t.Turno)}</td>
            <td>${t.AnoLetivo||""}</td>
            <td><button class="ver-alunos" data-turma="${t.TurmaID}" data-turmanome="${(t.Nome||"").replace(/"/g,'&quot;')}">Ver alunos</button></td>
          </tr>`;
        }).join("");

        preencherQtdAlunosPorTurma(CODIGO_CLIENTE, TOKEN_API, turmas);

        cardResumoTurmas.style.display="";
        cardResumoAlunos.style.display="";
        kpiTotalTurmas.textContent=turmas.length;
        statusResumoTurmas.textContent="Atualizado agora";

        kpiTotalAlunosUnidade.textContent="…";
        statusResumoAlunos.textContent="Atualizando…";
        const totalAlunos = await contarAlunosUnidade(CODIGO_CLIENTE, TOKEN_API, turmas);
        kpiTotalAlunosUnidade.textContent = totalAlunos;
        statusResumoAlunos.textContent = "Atualizado agora";
      }catch(e){
        console.error(e);
        tblTurmas.style.display="none";
        tbodyTurmas.innerHTML="";
        cardResumoTurmas.style.display="";
        cardResumoAlunos.style.display="";
        kpiTotalTurmas.textContent="—";
        kpiTotalAlunosUnidade.textContent="—";
        statusResumoTurmas.textContent="Erro";
        statusResumoAlunos.textContent="Erro";
      }
    }

    async function carregarAlunosDaTurma(turmaId, turmaNome){
      const { CODIGO_CLIENTE, TOKEN_API, nome } = getUnidadeAtual();
      abrirModal();
      modalAlunosTitulo.textContent = "Carregando alunos...";
      tblAlunos.style.display="none";
      tbodyAlunos.innerHTML="";
      try{
        const { nomeTurma, integrantes } = await getIntegrantesTurma(CODIGO_CLIENTE, TOKEN_API, turmaId);
        const labelNome = (nomeTurma || turmaNome || `Turma ${turmaId}`);
        modalAlunosTitulo.textContent = `${nome} – ${labelNome}: ${integrantes.length} aluno(s).`;
        tblAlunos.style.display="";
        // Ordem alfabética
        integrantes.sort((a, b) => a.Nome.localeCompare(b.Nome, 'pt', { sensitivity: 'base' }));

        tbodyAlunos.innerHTML = integrantes.map(a=>{
          const id = a.AlunoID || a.RA || "";
          const safeId = String(id).replace(/[^a-zA-Z0-9_-]/g, "");
          const alt = (a.Nome||"").replace(/"/g,'&quot;');
          return `
            <tr data-aluno-id="${id}">
              <td>
                <div class="aluno-cell">
                  <img class="aluno-foto" id="foto-${safeId}" src="./../img/profile.png" alt="${alt}">
                  <span style="cursor:pointer">${a.Nome || ""}</span>
                </div>
              </td>
              <td>${a.RA || ""}</td>
              <td>${a.Situacao || ""}</td>
            </tr>`;
        }).join("");

        // fotos
        integrantes.forEach((a, idx)=>{
          const id = a.AlunoID || a.RA || "";
          if(!id) return;
          const imgId = String(id).replace(/[^a-zA-Z0-9_-]/g, "");
          const imgEl = document.getElementById(`foto-${imgId}`);
          if(!imgEl) return;
          setTimeout(async ()=>{
            const src = await getFotoAluno(CODIGO_CLIENTE, TOKEN_API, id);
            if(src) imgEl.src = src;
          }, idx*120);
        });

      }catch(e){
        console.error(e);
        modalAlunosTitulo.textContent = `Erro ao carregar alunos da turma ${turmaId} (${nome}).`;
      }
    }

    selUnidade.addEventListener("change", carregarTurmas);

    document.addEventListener("click", async ev=>{
      const btn=ev.target.closest("button.ver-alunos");
      if(!btn) return;
      await carregarAlunosDaTurma(btn.getAttribute("data-turma"), btn.getAttribute("data-turmanome"));
    });

    btnFecharModal.addEventListener('click', fecharModal);
    modalAlunos.addEventListener('click', (e)=>{ if(e.target === modalAlunos) fecharModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modalAlunos.classList.contains('is-open')) fecharModal(); });

    // Clique na linha do aluno => abre BOX com rolagem
    let fichaListenerInstalado = false;
    function instalarListenerFicha(){
      if(fichaListenerInstalado) return;
      fichaListenerInstalado = true;

      tbodyAlunos.addEventListener('click', async (ev)=>{
        const tr = ev.target.closest('tr[data-aluno-id]');
        if(!tr) return;

        const id = tr.getAttribute('data-aluno-id');
        const nomeEl = tr.querySelector('.aluno-cell span');
        const nome = nomeEl ? nomeEl.textContent.trim() : '';

        const { CODIGO_CLIENTE, TOKEN_API } = getUnidadeAtual();
        modalFichaTitulo.textContent = 'Carregando ficha...';
        abrirModalFicha();

        try{
          const a = await getAlunoDetalhes(CODIGO_CLIENTE, TOKEN_API, id, nome);
          if(!a){
            modalFichaTitulo.textContent='Ficha do Aluno';
            return;
          }

          // Cabeçalho do box
          FX.nome.textContent = a.Nome || '';
          const idade = calcularIdade(a.DataNascimento);
          FX.sub.textContent = idade ? `${idade}` : '';
          // Foto do aluno
          const foto = await getFotoAluno(CODIGO_CLIENTE, TOKEN_API, a.AlunoID);
          FX.avatar.src = foto || "https://placehold.co/96x96/eeeeee/444?text=%F0%9F%91%A3";

          // Campos
          FX.sexo.textContent  = a.Sexo || '';
          FX.cpf.textContent   = a.CPF || '';
          FX.login.textContent = a.LoginPortal || '';
          FX.senha.textContent = a.SenhaPortal || '';

          const endParts = [
            a.Endereco || '',
            a.NumeroEndereco ? `, ${a.NumeroEndereco}` : '',
            a.Bairro ? ` – ${a.Bairro}` : '',
            a.Cidade ? ` – ${a.Cidade}` : '',
            a.CEP ? ` • CEP ${a.CEP}` : ''
          ];
          FX.end.textContent = endParts.join('');

          // Responsáveis (lista)
          if(a.Responsaveis && a.Responsaveis.length){
            FX.resps.innerHTML = a.Responsaveis.map(r=>(
              `<div class="responsavel"><strong>${r.Nome||'-'}</strong><br><span class="muted">${r.Parentesco||'-'}</span></div>`
            )).join("");
          }else{
            FX.resps.innerHTML = `<div class="muted">Sem responsáveis cadastrados.</div>`;
          }

          modalFichaTitulo.textContent = a.Nome ? `Ficha — ${a.Nome}` : 'Ficha do Aluno';
        }catch(e){
          console.error(e);
          modalFichaTitulo.textContent = 'Erro ao carregar a ficha';
        }
      });
    }
    instalarListenerFicha();

    // Inicialização
    carregarTurmas();
  </script>
</body>
</html>
